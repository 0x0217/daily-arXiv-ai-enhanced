let currentDate = '';
let availableDates = [];
let currentView = 'grid'; // 'grid' Êàñ 'list'
let currentCategory = 'all';
let paperData = {};
let flatpickrInstance = null;
let isRangeMode = false;
let activeAuthors = []; // Â≠òÂÇ®ÊøÄÊ¥ªÁöÑ‰ΩúËÄÖ
let userAuthors = []; // Â≠òÂÇ®Áî®Êà∑ÁöÑ‰ΩúËÄÖ
let searchQuery = ''; // Â≠òÂÇ®ÊêúÁ¥¢Êü•ËØ¢
let bookmarkedPapers = []; // Â≠òÂÇ®Êî∂ËóèÁöÑËÆ∫Êñá
let currentPaperIndex = 0; // ÂΩìÂâçÊü•ÁúãÁöÑËÆ∫ÊñáÁ¥¢Âºï
let currentFilteredPapers = []; // ÂΩìÂâçËøáÊª§ÂêéÁöÑËÆ∫ÊñáÂàóË°®
let translationCache = {}; // ÁºìÂ≠òÁøªËØëÁªìÊûú
let currentPaperData = null; // ÂΩìÂâçÊòæÁ§∫ÁöÑËÆ∫ÊñáÊï∞ÊçÆ

// Ê∏ÖÁêÜÊóßÁöÑÂÖ≥ÈîÆËØçËÆæÁΩÆ
function cleanupOldKeywordSettings() {
  // ÁßªÈô§ÊóßÁöÑÂÖ≥ÈîÆËØçÁõ∏ÂÖ≥ÁöÑlocalStorageÈ°π
  localStorage.removeItem('preferredKeywords');
  localStorage.removeItem('excludeKeywords');
}

// Âä†ËΩΩÊî∂ËóèÁöÑËÆ∫Êñá
function loadBookmarkedPapers() {
  const savedBookmarks = localStorage.getItem('bookmarkedPapers');
  if (savedBookmarks) {
    try {
      bookmarkedPapers = JSON.parse(savedBookmarks);
    } catch (error) {
      console.error('Ëß£ÊûêÊî∂ËóèËÆ∫ÊñáÂ§±Ë¥•:', error);
      bookmarkedPapers = [];
    }
  } else {
    bookmarkedPapers = [];
  }
}

// Âä†ËΩΩÁî®Êà∑ÁöÑ‰ΩúËÄÖËÆæÁΩÆ
function loadUserAuthors() {
  const savedAuthors = localStorage.getItem('preferredAuthors');
  if (savedAuthors) {
    try {
      userAuthors = JSON.parse(savedAuthors);
      // ÈªòËÆ§ÊøÄÊ¥ªÊâÄÊúâ‰ΩúËÄÖ
      activeAuthors = [...userAuthors];
    } catch (error) {
      console.error('Ëß£Êûê‰ΩúËÄÖÂ§±Ë¥•:', error);
      userAuthors = [];
      activeAuthors = [];
    }
  } else {
    userAuthors = [];
    activeAuthors = [];
  }

  renderAuthorTags();
}

// ËÆæÁΩÆÊêúÁ¥¢Êü•ËØ¢
function setSearchQuery(query) {
  searchQuery = query.toLowerCase().trim();
  renderPapers();
}

// ÂàùÂßãÂåñÊêúÁ¥¢ÂäüËÉΩ
function initSearchFunctionality() {
  const searchInput = document.getElementById('searchInput');
  const clearSearchBtn = document.getElementById('clearSearch');

  if (!searchInput || !clearSearchBtn) return;

  // ÊêúÁ¥¢ËæìÂÖ•‰∫ã‰ª∂
  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.trim();
    setSearchQuery(query);

    // ÊòæÁ§∫/ÈöêËóèÊ∏ÖÈô§ÊåâÈíÆ
    clearSearchBtn.style.display = query ? 'flex' : 'none';
  });

  // Ê∏ÖÈô§ÊêúÁ¥¢
  clearSearchBtn.addEventListener('click', () => {
    searchInput.value = '';
    setSearchQuery('');
    clearSearchBtn.style.display = 'none';
    searchInput.focus();
  });

  // EnterÈîÆÊêúÁ¥¢
  searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      setSearchQuery(searchInput.value.trim());
    }
  });
}

// Ê∏≤Êüì‰ΩúËÄÖÊ†áÁ≠æ
function renderAuthorTags() {
  const authorTagsElement = document.getElementById('authorTags');
  const authorContainer = document.querySelector('.author-label-container');

  if (!userAuthors || userAuthors.length === 0) {
    authorContainer.style.display = 'none';
    return;
  }

  authorContainer.style.display = 'flex';
  authorTagsElement.innerHTML = '';

  // Ê∑ªÂä†‰ΩúËÄÖÊ†áÁ≠æ
  userAuthors.forEach(author => {
    const tagElement = document.createElement('span');
    tagElement.className = `category-button ${activeAuthors.includes(author) ? 'active' : ''}`;
    tagElement.dataset.author = author;
    tagElement.textContent = author;
    // Ê∑ªÂä†ÊèêÁ§∫‰ø°ÊÅØÔºåËß£Èáä‰ΩúËÄÖÂåπÈÖçÁöÑËåÉÂõ¥
    tagElement.title = "ÂåπÈÖç‰ΩúËÄÖÂàóË°®‰∏≠ÁöÑÂêçÂ≠ó";

    tagElement.addEventListener('click', () => {
      toggleAuthorFilter(author);
    });

    authorTagsElement.appendChild(tagElement);

    // Ê∑ªÂä†Âá∫Áé∞Âä®ÁîªÂêéÁßªÈô§Âä®ÁîªÁ±ª
    if (!activeAuthors.includes(author)) {
      tagElement.classList.add('tag-appear');
      setTimeout(() => {
        tagElement.classList.remove('tag-appear');
      }, 300);
    }
  });

  // // Ê∑ªÂä†"Ê∏ÖÈô§ÂÖ®ÈÉ®"ÊåâÈíÆÂíåÈÄªËæëÊèêÁ§∫
  // if (activeAuthors.length > 0) {
  //   const logicIndicator = document.createElement('span');
  //   logicIndicator.className = 'logic-indicator';
  //   logicIndicator.textContent = 'SORT';
  //   // Ê∑ªÂä†ÊèêÁ§∫‰ø°ÊÅØÔºåËß£ÈáäÊéíÂ∫èÈÄªËæë
  //   logicIndicator.title = "Â§ö‰∏™‰ΩúËÄÖ‰ΩøÁî®'Êàñ'ÈÄªËæëÔºåÂåπÈÖç‰ªª‰∏Ä‰ΩúËÄÖÁöÑËÆ∫Êñá‰ºöË¢´‰ºòÂÖàÊòæÁ§∫";
  //   authorTagsElement.appendChild(logicIndicator);

  //   const clearButton = document.createElement('span');
  //   clearButton.className = 'category-button clear-button';
  //   clearButton.textContent = 'Clear';
  //   clearButton.addEventListener('click', clearAllAuthors);
  //   authorTagsElement.appendChild(clearButton);
  // }
}

// ÂàáÊç¢‰ΩúËÄÖËøáÊª§
function toggleAuthorFilter(author) {
  const index = activeAuthors.indexOf(author);

  if (index === -1) {
    // ÊøÄÊ¥ªËØ•‰ΩúËÄÖ
    activeAuthors.push(author);
  } else {
    // ÂèñÊ∂àÊøÄÊ¥ªËØ•‰ΩúËÄÖ
    activeAuthors.splice(index, 1);
  }

  // Êõ¥Êñ∞‰ΩúËÄÖÊ†áÁ≠æUI
  const authorTags = document.querySelectorAll('[data-author]');
  authorTags.forEach(tag => {
    if (tag.dataset.author === author) {
      // ÂÖàÁßªÈô§‰∏ä‰∏ÄÊ¨°ÂèØËÉΩÁöÑÈ´ò‰∫ÆÂä®Áîª
      tag.classList.remove('tag-highlight');

      // Ê∑ªÂä†/ÁßªÈô§ÊøÄÊ¥ªÁä∂ÊÄÅ
      tag.classList.toggle('active', activeAuthors.includes(author));

      // Ê∑ªÂä†È´ò‰∫ÆÂä®Áîª
      setTimeout(() => {
        tag.classList.add('tag-highlight');
      }, 10);

      // ÁßªÈô§È´ò‰∫ÆÂä®Áîª
      setTimeout(() => {
        tag.classList.remove('tag-highlight');
      }, 1000);
    }
  });

  // ÈáçÊñ∞Ê∏≤ÊüìËÆ∫ÊñáÂàóË°®
  renderPapers();
}

// Êî∂ËóèËÆ∫Êñá
function toggleBookmark(paper) {
  const paperKey = `${paper.id}-${paper.date}`;
  const existingIndex = bookmarkedPapers.findIndex(p => `${p.id}-${p.date}` === paperKey);

  if (existingIndex === -1) {
    // Ê∑ªÂä†Êî∂Ëóè
    const bookmarkData = {
      ...paper,
      bookmarkedAt: new Date().toISOString()
    };
    bookmarkedPapers.push(bookmarkData);
    showNotification('Paper bookmarked successfully!', 'success');
  } else {
    // ÂèñÊ∂àÊî∂Ëóè
    bookmarkedPapers.splice(existingIndex, 1);
    showNotification('Bookmark removed!', 'info');
  }

  // ‰øùÂ≠òÂà∞ localStorage
  localStorage.setItem('bookmarkedPapers', JSON.stringify(bookmarkedPapers));

  // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
  updateBookmarkButton(paper);
}

// Ê£ÄÊü•ËÆ∫ÊñáÊòØÂê¶Â∑≤Êî∂Ëóè
function isBookmarked(paper) {
  const paperKey = `${paper.id}-${paper.date}`;
  return bookmarkedPapers.some(p => `${p.id}-${p.date}` === paperKey);
}

// Êõ¥Êñ∞Êî∂ËóèÊåâÈíÆÁä∂ÊÄÅ
function updateBookmarkButton(paper) {
  const bookmarkButton = document.querySelector('.bookmark-button');
  if (bookmarkButton) {
    const isBookmarkedPaper = isBookmarked(paper);
    bookmarkButton.classList.toggle('bookmarked', isBookmarkedPaper);
    bookmarkButton.title = isBookmarkedPaper ? 'Remove from bookmarks' : 'Add to bookmarks';
  }
}

// ‰∏ãËΩΩËÆ∫ÊñáPDF
function downloadPaper(paper) {
  // Generate filename with special prefix
  const safeTitle = paper.title
    .substring(0, 50)
    .replace(/[^a-zA-Z0-9\s-]/g, '')
    .replace(/\s+/g, '_')
    .toLowerCase();

  const filename = `ArXiv-AI-${paper.id}_${safeTitle}.pdf`;
  const downloadUrl = paper.url.replace('abs', 'pdf');

  // Create a temporary link with download attribute to force download
  const link = document.createElement('a');
  link.href = downloadUrl;
  link.download = filename;
  link.style.display = 'none';

  // Some browsers need the link to be in the DOM
  document.body.appendChild(link);

  // Trigger the download
  link.click();

  // Clean up
  document.body.removeChild(link);

  // Show notification
  showNotification(`Download started: ${filename}`, 'success');
}

// ÊòæÁ§∫‰∏ãËΩΩÈÄâÈ°πÊ®°ÊÄÅÊ°Ü
function showDownloadModal(paper) {
  const modal = document.createElement('div');
  modal.className = 'download-modal';
  modal.innerHTML = `
    <div class="download-modal-content">
      <div class="download-modal-header">
        <h3>Download Paper</h3>
        <button class="close-download-modal">√ó</button>
      </div>
      <div class="download-modal-body">
        <div class="download-info">
          <p><strong>Title:</strong> ${paper.title.substring(0, 100)}${paper.title.length > 100 ? '...' : ''}</p>
          <p><strong>Paper ID:</strong> ${paper.id}</p>
        </div>

        <div class="download-options">
          <h4>Download Options:</h4>

          <div class="download-format-section">
            <label>
              <input type="radio" name="downloadFormat" value="pdf" checked>
              PDF (Original)
            </label>
            <label>
              <input type="radio" name="downloadFormat" value="source">
              Source Files (if available)
            </label>
          </div>

          <div class="filename-section">
            <label for="customFilename">Custom Filename:</label>
            <input type="text" id="customFilename" value="${generateFilename(paper)}" placeholder="Enter filename">
            <small>The file extension will be added automatically</small>
          </div>

          <div class="folder-hint">
            <p><strong>Note:</strong> Due to browser security limitations, files will be downloaded to your default Downloads folder. You can organize them later or use browser settings to specify download locations.</p>

            <div class="download-tips">
              <h5>üí° Download Tips:</h5>
              <ul>
                <li>Use Chrome's "Ask where to save each file" setting for custom locations</li>
                <li>Create folders like "Papers", "Research", or "ArXiv" for better organization</li>
                <li>Consider using a download manager for better file organization</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="download-modal-footer">
        <button class="button secondary cancel-download">Cancel</button>
        <button class="button primary confirm-download">Download</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
  const closeButton = modal.querySelector('.close-download-modal');
  const cancelButton = modal.querySelector('.cancel-download');
  const confirmButton = modal.querySelector('.confirm-download');

  const closeModal = () => {
    document.body.removeChild(modal);
  };

  closeButton.addEventListener('click', closeModal);
  cancelButton.addEventListener('click', closeModal);

  confirmButton.addEventListener('click', () => {
    const format = modal.querySelector('input[name="downloadFormat"]:checked').value;
    const customFilename = modal.querySelector('#customFilename').value.trim();

    executeDownload(paper, format, customFilename);
    closeModal();
  });

  // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeModal();
    }
  });
}

// ÁîüÊàêÊñá‰ª∂Âêç
function generateFilename(paper) {
  const safeTitle = paper.title
    .substring(0, 50)
    .replace(/[^a-zA-Z0-9\s-]/g, '')
    .replace(/\s+/g, '_')
    .toLowerCase();

  return `${paper.id}_${safeTitle}`;
}

// ÊâßË°å‰∏ãËΩΩ
function executeDownload(paper, format, customFilename) {
  let downloadUrl;
  let filename;

  if (format === 'pdf') {
    downloadUrl = paper.url.replace('abs', 'pdf');
    filename = customFilename || generateFilename(paper);
    if (!filename.endsWith('.pdf')) {
      filename += '.pdf';
    }
  } else if (format === 'source') {
    // Â∞ùËØïÊ∫êÊñá‰ª∂‰∏ãËΩΩ
    downloadUrl = paper.url.replace('abs', 'src');
    filename = customFilename || generateFilename(paper);
    if (!filename.endsWith('.tar.gz')) {
      filename += '.tar.gz';
    }
  }

  // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
  const link = document.createElement('a');
  link.href = downloadUrl;
  link.download = filename;
  link.target = '_blank';

  // Ê∑ªÂä†Âà∞DOMÂπ∂Ëß¶Âèë‰∏ãËΩΩ
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  // ÊòæÁ§∫‰∏ãËΩΩÈÄöÁü•
  showDownloadNotification(filename, format);
}

// ÊòæÁ§∫‰∏ãËΩΩÈÄöÁü•
function showDownloadNotification(filename, format) {
  const formatText = format === 'pdf' ? 'PDF' : 'Source files';
  showNotification(`${formatText} download started: ${filename}`, 'success');

  // ‰øùÂ≠ò‰∏ãËΩΩÂéÜÂè≤
  saveDownloadHistory(filename, format);
}

// ‰øùÂ≠ò‰∏ãËΩΩÂéÜÂè≤
function saveDownloadHistory(filename, format) {
  const downloadHistory = JSON.parse(localStorage.getItem('downloadHistory') || '[]');

  downloadHistory.unshift({
    filename,
    format,
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleDateString()
  });

  // ‰øùÁïôÊúÄËøë50Ê¨°‰∏ãËΩΩËÆ∞ÂΩï
  if (downloadHistory.length > 50) {
    downloadHistory.splice(50);
  }

  localStorage.setItem('downloadHistory', JSON.stringify(downloadHistory));
}

// ÊòæÁ§∫ÈÄöÁü•
function showNotification(message, type = 'info') {
  // ÂàõÂª∫ÈÄöÁü•ÂÖÉÁ¥†
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.textContent = message;

  // Ê∑ªÂä†Ê†∑Âºè
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    z-index: 10000;
    font-weight: 500;
    animation: slideInNotification 0.3s ease;
  `;

  // Ê∑ªÂä†Âà∞È°µÈù¢
  document.body.appendChild(notification);

  // 3ÁßíÂêéËá™Âä®ÁßªÈô§
  setTimeout(() => {
    notification.style.animation = 'slideOutNotification 0.3s ease';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// ÁøªËØëÊñáÊú¨
async function translateText(text, targetLang = 'zh') {
  const cacheKey = `${text}_${targetLang}`;

  // Ê£ÄÊü•ÁºìÂ≠ò
  if (translationCache[cacheKey]) {
    return translationCache[cacheKey];
  }

  try {
    // ‰ΩøÁî® MyMemory ÂÖçË¥πÁøªËØë API (Êó†ÈúÄ API key)
    const encodedText = encodeURIComponent(text);
    const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodedText}&langpair=en|${targetLang}`);
    const data = await response.json();

    if (data.responseStatus === 200 && data.responseData) {
      const translation = data.responseData.translatedText;
      // ÁºìÂ≠òÁøªËØëÁªìÊûú
      translationCache[cacheKey] = translation;
      // ‰øùÂ≠òÂà∞ localStorage
      localStorage.setItem('translationCache', JSON.stringify(translationCache));
      return translation;
    } else {
      throw new Error('Translation failed');
    }
  } catch (error) {
    console.error('Translation error:', error);
    // Â¶ÇÊûúÁøªËØëÂ§±Ë¥•ÔºåËøîÂõûÂéüÊñá
    return text;
  }
}

// Âä†ËΩΩÁøªËØëÁºìÂ≠ò
function loadTranslationCache() {
  const savedCache = localStorage.getItem('translationCache');
  if (savedCache) {
    try {
      translationCache = JSON.parse(savedCache);
    } catch (error) {
      console.error('Ëß£ÊûêÁøªËØëÁºìÂ≠òÂ§±Ë¥•:', error);
      translationCache = {};
    }
  }
}

// ÁøªËØëËÆ∫ÊñáÊëòË¶Å
async function translatePaperSummary(paper, targetLang = 'zh') {
  const summaryElement = document.querySelector('.paper-summary-content');
  const translateButton = document.querySelector('.translate-button');

  if (!summaryElement || !translateButton) return;

  // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
  translateButton.disabled = true;
  translateButton.innerHTML = `
    <svg class="loading-spinner" viewBox="0 0 24 24" width="20" height="20">
      <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="31.416" stroke-dashoffset="31.416" style="animation: spin 1s linear infinite;">
        <animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/>
        <animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416" repeatCount="indefinite"/>
      </circle>
    </svg>
    Translating...
  `;

  try {
    // ÁøªËØëÊ†áÈ¢ò„ÄÅÊëòË¶ÅÂíåÂêÑ‰∏™ÈÉ®ÂàÜ
    const translatedTitle = await translateText(paper.title, targetLang);
    const translatedSummary = await translateText(paper.summary, targetLang);

    let translatedMotivation = '';
    let translatedMethod = '';
    let translatedResult = '';
    let translatedConclusion = '';
    let translatedAbstract = '';

    if (paper.motivation) {
      translatedMotivation = await translateText(paper.motivation, targetLang);
    }
    if (paper.method) {
      translatedMethod = await translateText(paper.method, targetLang);
    }
    if (paper.result) {
      translatedResult = await translateText(paper.result, targetLang);
    }
    if (paper.conclusion) {
      translatedConclusion = await translateText(paper.conclusion, targetLang);
    }
    if (paper.details) {
      translatedAbstract = await translateText(paper.details, targetLang);
    }

    // Êõ¥Êñ∞È°µÈù¢ÂÜÖÂÆπ
    updatePaperDetailsWithTranslation(paper, {
      title: translatedTitle,
      summary: translatedSummary,
      motivation: translatedMotivation,
      method: translatedMethod,
      result: translatedResult,
      conclusion: translatedConclusion,
      abstract: translatedAbstract
    });

    // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
    translateButton.disabled = false;
    translateButton.innerHTML = `
      <svg viewBox="0 0 24 24" width="20" height="20">
        <path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z" fill="currentColor"/>
      </svg>
      Show Original
    `;

    // ÂàáÊç¢ÊåâÈíÆÂäüËÉΩÂà∞ÊòæÁ§∫ÂéüÊñá
    translateButton.onclick = () => showOriginalContent(paper);

    showNotification('Translation completed!', 'success');
  } catch (error) {
    console.error('Translation failed:', error);
    translateButton.disabled = false;
    translateButton.innerHTML = `
      <svg viewBox="0 0 24 24" width="20" height="20">
        <path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z" fill="currentColor"/>
      </svg>
      Translate
    `;
    showNotification('Translation failed. Please try again.', 'error');
  }
}

// ÊòæÁ§∫ÂéüÂßãÂÜÖÂÆπ
function showOriginalContent(paper) {
  updatePaperDetailsWithTranslation(paper, {
    title: paper.title,
    summary: paper.summary,
    motivation: paper.motivation || '',
    method: paper.method || '',
    result: paper.result || '',
    conclusion: paper.conclusion || '',
    abstract: paper.details || ''
  });

  const translateButton = document.querySelector('.translate-button');
  if (translateButton) {
    translateButton.innerHTML = `
      <svg viewBox="0 0 24 24" width="20" height="20">
        <path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z" fill="currentColor"/>
      </svg>
      Translate
    `;
    translateButton.onclick = () => translatePaperSummary(paper);
  }
}

// Êõ¥Êñ∞ËÆ∫ÊñáËØ¶ÊÉÖÈ°µÈù¢ÂÜÖÂÆπ
function updatePaperDetailsWithTranslation(paper, translations) {
  const modalTitle = document.getElementById('modalTitle');
  const paperIndex = currentPaperIndex + 1;

  if (modalTitle) {
    modalTitle.innerHTML = `<span class="paper-index-badge">${paperIndex}</span> ${translations.title}`;
  }

  // Êõ¥Êñ∞ÂêÑ‰∏™ÈÉ®ÂàÜÁöÑÂÜÖÂÆπ
  const summaryContent = document.querySelector('.paper-summary-content');
  if (summaryContent) {
    summaryContent.innerHTML = translations.summary;
  }

  const motivationSection = document.querySelector('.paper-section[data-section="motivation"] p');
  if (motivationSection && translations.motivation) {
    motivationSection.innerHTML = translations.motivation;
  }

  const methodSection = document.querySelector('.paper-section[data-section="method"] p');
  if (methodSection && translations.method) {
    methodSection.innerHTML = translations.method;
  }

  const resultSection = document.querySelector('.paper-section[data-section="result"] p');
  if (resultSection && translations.result) {
    resultSection.innerHTML = translations.result;
  }

  const conclusionSection = document.querySelector('.paper-section[data-section="conclusion"] p');
  if (conclusionSection && translations.conclusion) {
    conclusionSection.innerHTML = translations.conclusion;
  }

  const abstractSection = document.querySelector('.original-abstract');
  if (abstractSection && translations.abstract) {
    abstractSection.innerHTML = translations.abstract;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  initEventListeners();

  // ËÆæÁΩÆGitHubÈìæÊé•
  setGitHubLinks();

  fetchGitHubStats();

  // Âä†ËΩΩÁî®Êà∑ÂÖ≥ÈîÆËØç
  cleanupOldKeywordSettings();

  // Âä†ËΩΩÁî®Êà∑‰ΩúËÄÖ
  loadUserAuthors();

  // Âä†ËΩΩÊî∂ËóèÁöÑËÆ∫Êñá
  loadBookmarkedPapers();

  // ÂàùÂßãÂåñÊêúÁ¥¢ÂäüËÉΩ
  initSearchFunctionality();

  // Âä†ËΩΩÁøªËØëÁºìÂ≠ò
  loadTranslationCache();

  fetchAvailableDates().then(() => {
    if (availableDates.length > 0) {
      loadPapersByDate(availableDates[0]);
    }
  });
});

// Ëé∑ÂèñÂΩìÂâç‰ªìÂ∫ì‰ø°ÊÅØ
function getCurrentRepoInfo() {
  const currentUrl = window.location.hostname;
  let username = 'dw-dengwei'; // fallback
  let repoName = 'daily-arXiv-ai-enhanced'; // fallback

  // If running on GitHub Pages, extract repo info from URL
  if (currentUrl.includes('github.io')) {
    const parts = currentUrl.split('.');
    if (parts.length >= 2) {
      username = parts[0];
      const pathname = window.location.pathname;
      repoName = pathname.split('/')[1] || 'daily-arXiv-ai-enhanced';
    }
  }

  return { username, repoName };
}

// ËÆæÁΩÆGitHubÈìæÊé•
function setGitHubLinks() {
  const { username, repoName } = getCurrentRepoInfo();
  const repoUrl = `https://github.com/${username}/${repoName}`;

  // Êõ¥Êñ∞header‰∏≠ÁöÑGitHubÈìæÊé•
  const githubRepoLink = document.getElementById('githubRepoLink');
  if (githubRepoLink) {
    githubRepoLink.href = repoUrl;
  }

  // Êõ¥Êñ∞footer‰∏≠ÁöÑGitHubÈìæÊé•
  const githubFooterLink = document.getElementById('githubFooterLink');
  if (githubFooterLink) {
    githubFooterLink.href = repoUrl;
  }
}

async function fetchGitHubStats() {
  try {
    const { username, repoName } = getCurrentRepoInfo();
    const repoUrl = `https://api.github.com/repos/${username}/${repoName}`;

    const response = await fetch(repoUrl);
    const data = await response.json();
    const starCount = data.stargazers_count;
    const forkCount = data.forks_count;

    document.getElementById('starCount').textContent = starCount;
    document.getElementById('forkCount').textContent = forkCount;
  } catch (error) {
    console.error('Ëé∑ÂèñGitHubÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', error);
    document.getElementById('starCount').textContent = '?';
    document.getElementById('forkCount').textContent = '?';
  }
}

function initEventListeners() {
  // Êó•ÊúüÈÄâÊã©Âô®Áõ∏ÂÖ≥ÁöÑ‰∫ã‰ª∂ÁõëÂê¨
  const calendarButton = document.getElementById('calendarButton');
  calendarButton.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleDatePicker();
  });

  const datePickerModal = document.querySelector('.date-picker-modal');
  datePickerModal.addEventListener('click', (event) => {
    if (event.target === datePickerModal) {
      toggleDatePicker();
    }
  });

  const datePickerContent = document.querySelector('.date-picker-content');
  datePickerContent.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  document.getElementById('dateRangeMode').addEventListener('change', toggleRangeMode);

  // ÂÖ∂‰ªñÂéüÊúâÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
  document.getElementById('closeModal').addEventListener('click', closeModal);

  document.querySelector('.paper-modal').addEventListener('click', (event) => {
    const modal = document.querySelector('.paper-modal');
    const pdfContainer = modal.querySelector('.pdf-container');

    // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊ®°ÊÄÅÊ°ÜËÉåÊôØ
    if (event.target === modal) {
      // Ê£ÄÊü•PDFÊòØÂê¶Â§Ñ‰∫éÊîæÂ§ßÁä∂ÊÄÅ
      if (pdfContainer && pdfContainer.classList.contains('expanded')) {
        // Â¶ÇÊûúPDFÊòØÊîæÂ§ßÁöÑÔºåÂÖàÂ∞ÜÂÖ∂ÊÅ¢Â§çÊ≠£Â∏∏Â§ßÂ∞è
        const expandButton = modal.querySelector('.pdf-expand-btn');
        if (expandButton) {
          togglePdfSize(expandButton);
        }
        // ÈòªÊ≠¢‰∫ã‰ª∂ÁªßÁª≠‰º†Êí≠ÔºåÈò≤Ê≠¢ÂÖ≥Èó≠Êï¥‰∏™Ê®°ÊÄÅÊ°Ü
        event.stopPropagation();
      } else {
        // Â¶ÇÊûúPDF‰∏çÊòØÊîæÂ§ßÁä∂ÊÄÅÔºåÂàôÂÖ≥Èó≠Êï¥‰∏™Ê®°ÊÄÅÊ°Ü
        closeModal();
      }
    }
  });

  // Ê∑ªÂä†ÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨ - Esc ÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÔºåÂ∑¶Âè≥ÁÆ≠Â§¥ÈîÆÂàáÊç¢ËÆ∫ÊñáÔºåR ÈîÆÊòæÁ§∫ÈöèÊú∫ËÆ∫Êñá
  document.addEventListener('keydown', (event) => {
    // Ê£ÄÊü•ÊòØÂê¶ÊúâËæìÂÖ•Ê°ÜÊàñÊñáÊú¨Âå∫ÂüüÂ§Ñ‰∫éÁÑ¶ÁÇπÁä∂ÊÄÅ
    const activeElement = document.activeElement;
    const isInputFocused = activeElement && (
      activeElement.tagName === 'INPUT' ||
      activeElement.tagName === 'TEXTAREA' ||
      activeElement.isContentEditable
    );

    if (event.key === 'Escape') {
      const paperModal = document.getElementById('paperModal');
      const datePickerModal = document.getElementById('datePickerModal');

      // ÂÖ≥Èó≠ËÆ∫ÊñáÊ®°ÊÄÅÊ°Ü
      if (paperModal.classList.contains('active')) {
        closeModal();
      }
      // ÂÖ≥Èó≠Êó•ÊúüÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü
      else if (datePickerModal.classList.contains('active')) {
        toggleDatePicker();
      }
    }
    // Â∑¶Âè≥ÁÆ≠Â§¥ÈîÆÂØºËà™ËÆ∫ÊñáÔºà‰ªÖÂú®ËÆ∫ÊñáÊ®°ÊÄÅÊ°ÜÊâìÂºÄÊó∂Ôºâ
    else if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
      const paperModal = document.getElementById('paperModal');
      if (paperModal.classList.contains('active')) {
        event.preventDefault(); // Èò≤Ê≠¢È°µÈù¢ÊªöÂä®

        if (event.key === 'ArrowLeft') {
          navigateToPreviousPaper();
        } else if (event.key === 'ArrowRight') {
          navigateToNextPaper();
        }
      }
    }
    // space ÈîÆÊòæÁ§∫ÈöèÊú∫ËÆ∫ÊñáÔºàÂú®Ê≤°ÊúâËæìÂÖ•Ê°ÜÁÑ¶ÁÇπ‰∏îÊó•ÊúüÈÄâÊã©Âô®Êú™ÊâìÂºÄÊó∂Ôºâ
    else if (event.key === ' ' || event.key === 'Spacebar') {
      const paperModal = document.getElementById('paperModal');
      const datePickerModal = document.getElementById('datePickerModal');

      // Âè™ÊúâÂú®Ê≤°ÊúâËæìÂÖ•Ê°ÜÁÑ¶ÁÇπ‰∏îÊó•ÊúüÈÄâÊã©Âô®Ê≤°ÊúâÊâìÂºÄÊó∂ÊâçËß¶Âèë
      // Áé∞Âú®ÂÖÅËÆ∏Âú®ËÆ∫ÊñáÊ®°ÊÄÅÊ°ÜÊâìÂºÄÊó∂‰πüËÉΩ‰ΩøÁî®RÈîÆÂàáÊç¢Âà∞ÈöèÊú∫ËÆ∫Êñá
      if (!isInputFocused && !datePickerModal.classList.contains('active')) {
        event.preventDefault(); // Èò≤Ê≠¢È°µÈù¢Âà∑Êñ∞
        event.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
        showRandomPaper();
      }
    }
  });

  // Ê∑ªÂä†Èº†Ê†áÊªöËΩÆÊ®™ÂêëÊªöÂä®ÊîØÊåÅ
  const categoryScroll = document.querySelector('.category-scroll');
  const keywordScroll = document.querySelector('.keyword-scroll');
  const authorScroll = document.querySelector('.author-scroll');

  // ‰∏∫Á±ªÂà´ÊªöÂä®Ê∑ªÂä†Èº†Ê†áÊªöËΩÆ‰∫ã‰ª∂
  if (categoryScroll) {
    categoryScroll.addEventListener('wheel', function(e) {
      if (e.deltaY !== 0) {
        e.preventDefault();
        this.scrollLeft += e.deltaY;
      }
    });
  }

  // ‰∏∫ÂÖ≥ÈîÆËØçÊªöÂä®Ê∑ªÂä†Èº†Ê†áÊªöËΩÆ‰∫ã‰ª∂
  if (keywordScroll) {
    keywordScroll.addEventListener('wheel', function(e) {
      if (e.deltaY !== 0) {
        e.preventDefault();
        this.scrollLeft += e.deltaY;
      }
    });
  }

  // ‰∏∫‰ΩúËÄÖÊªöÂä®Ê∑ªÂä†Èº†Ê†áÊªöËΩÆ‰∫ã‰ª∂
  if (authorScroll) {
    authorScroll.addEventListener('wheel', function(e) {
      if (e.deltaY !== 0) {
        e.preventDefault();
        this.scrollLeft += e.deltaY;
      }
    });
  }

  // ÂÖ∂‰ªñ‰∫ã‰ª∂ÁõëÂê¨Âô®...
  const categoryButtons = document.querySelectorAll('.category-button');
  categoryButtons.forEach(button => {
    button.addEventListener('click', () => {
      const category = button.dataset.category;
      filterByCategory(category);
    });
  });
}

// Helper function to determine which AI enhanced file language is available for a date
// This function is language-agnostic and will work with any language (Chinese, Korean, English, etc.)
function getAIEnhancedLanguage(date, fileList) {
  // Look for any AI enhanced file for the given date
  const aiEnhancedFile = fileList.find(file =>
    file.startsWith(`${date}_AI_enhanced_`) && file.endsWith('.jsonl')
  );

  if (aiEnhancedFile) {
    // Extract language from filename: date_AI_enhanced_LANGUAGE.jsonl
    const match = aiEnhancedFile.match(/_AI_enhanced_(.+)\.jsonl$/);
    return match ? match[1] : null;
  }

  return null;
}

// Global variable to store available file info (date -> language mapping)
// Supports any language dynamically (Chinese, Korean, English, Spanish, etc.)
let availableDateFiles = {};

async function fetchAvailableDates() {
  try {
    const response = await fetch('assets/file-list.txt');
    if (!response.ok) {
      console.error('Error fetching file list:', response.status);
      return [];
    }
    const text = await response.text();
    const files = text.trim().split('\n');

    const dateRegex = /(\d{4}-\d{2}-\d{2})_AI_enhanced_(.+)\.jsonl/;
    const dates = [];
    availableDateFiles = {}; // Reset the file mapping

    files.forEach(file => {
      const match = file.match(dateRegex);
      if (match && match[1] && match[2]) {
        const date = match[1];
        const language = match[2];
        dates.push(date);
        availableDateFiles[date] = language;
      }
    });
    availableDates = [...new Set(dates)];
    availableDates.sort((a, b) => new Date(b) - new Date(a));

    initDatePicker(); // Assuming this function uses availableDates

    return availableDates;
  } catch (error) {
    console.error('Ëé∑ÂèñÂèØÁî®Êó•ÊúüÂ§±Ë¥•:', error);
  }
}

function initDatePicker() {
  const datepickerInput = document.getElementById('datepicker');

  if (flatpickrInstance) {
    flatpickrInstance.destroy();
  }

  // ÂàõÂª∫ÂèØÁî®Êó•ÊúüÁöÑÊò†Â∞ÑÔºåÁî®‰∫éÁ¶ÅÁî®Êó†ÊïàÊó•Êúü
  const enabledDatesMap = {};
  availableDates.forEach(date => {
    enabledDatesMap[date] = true;
  });

  // ÈÖçÁΩÆ Flatpickr
  flatpickrInstance = flatpickr(datepickerInput, {
    inline: true,
    dateFormat: "Y-m-d",
    defaultDate: availableDates[0],
    enable: [
      function(date) {
        // Âè™ÂêØÁî®ÊúâÊïàÊó•Êúü
        const dateStr = date.getFullYear() + "-" +
                        String(date.getMonth() + 1).padStart(2, '0') + "-" +
                        String(date.getDate()).padStart(2, '0');
        return !!enabledDatesMap[dateStr];
      }
    ],
    onChange: function(selectedDates, dateStr) {
      if (isRangeMode && selectedDates.length === 2) {
        // Â§ÑÁêÜÊó•ÊúüËåÉÂõ¥ÈÄâÊã©
        const startDate = formatDateForAPI(selectedDates[0]);
        const endDate = formatDateForAPI(selectedDates[1]);
        loadPapersByDateRange(startDate, endDate);
        toggleDatePicker();
      } else if (!isRangeMode && selectedDates.length === 1) {
        // Â§ÑÁêÜÂçï‰∏™Êó•ÊúüÈÄâÊã©
        const selectedDate = formatDateForAPI(selectedDates[0]);
        if (availableDates.includes(selectedDate)) {
          loadPapersByDate(selectedDate);
          toggleDatePicker();
        }
      }
    }
  });

  // ÈöêËóèÊó•ÊúüËæìÂÖ•Ê°Ü
  const inputElement = document.querySelector('.flatpickr-input');
  if (inputElement) {
    inputElement.style.display = 'none';
  }
}

function formatDateForAPI(date) {
  return date.getFullYear() + "-" +
         String(date.getMonth() + 1).padStart(2, '0') + "-" +
         String(date.getDate()).padStart(2, '0');
}

function toggleRangeMode() {
  isRangeMode = document.getElementById('dateRangeMode').checked;

  if (flatpickrInstance) {
    flatpickrInstance.set('mode', isRangeMode ? 'range' : 'single');
  }
}

async function loadPapersByDate(date) {
  currentDate = date;
  document.getElementById('currentDate').textContent = formatDate(date);

  // Êõ¥Êñ∞Êó•ÊúüÈÄâÊã©Âô®‰∏≠ÁöÑÈÄâ‰∏≠Êó•Êúü
  if (flatpickrInstance) {
    flatpickrInstance.setDate(date, false);
  }

  // ‰∏çÂÜçÈáçÁΩÆÊøÄÊ¥ªÁöÑÂÖ≥ÈîÆËØçÂíå‰ΩúËÄÖ
  // ËÄåÊòØ‰øùÊåÅÂΩìÂâçÈÄâÊã©Áä∂ÊÄÅ

  const container = document.getElementById('paperContainer');
  container.innerHTML = `
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading paper...</p>
    </div>
  `;

  try {
    const language = availableDateFiles[date] || 'Chinese';
    const response = await fetch(`data/${date}_AI_enhanced_${language}.jsonl`);
    const text = await response.text();

    paperData = parseJsonlData(text, date);

    const categories = getAllCategories(paperData);

    renderCategoryFilter(categories);

    renderPapers();
  } catch (error) {
    console.error('Âä†ËΩΩËÆ∫ÊñáÊï∞ÊçÆÂ§±Ë¥•:', error);
    container.innerHTML = `
      <div class="loading-container">
        <p>Loading data fails. Please retry.</p>
        <p>Error messages: ${error.message}</p>
      </div>
    `;
  }
}

function parseJsonlData(jsonlText, date) {
  const result = {};

  const lines = jsonlText.trim().split('\n');

  lines.forEach(line => {
    try {
      const paper = JSON.parse(line);

      if (!paper.categories) {
        return;
      }

      let allCategories = Array.isArray(paper.categories) ? paper.categories : [paper.categories];

      const primaryCategory = allCategories[0];

      if (!result[primaryCategory]) {
        result[primaryCategory] = [];
      }

      const summary = paper.AI && paper.AI.tldr ? paper.AI.tldr : paper.summary;

      result[primaryCategory].push({
        title: paper.title,
        url: paper.abs || paper.pdf || `https://arxiv.org/abs/${paper.id}`,
        authors: Array.isArray(paper.authors) ? paper.authors.join(', ') : paper.authors,
        category: allCategories,
        summary: summary,
        details: paper.summary || '',
        translatedSummary: paper.AI && paper.AI.translated_summary ? paper.AI.translated_summary : '',
        date: date,
        id: paper.id,
        motivation: paper.AI && paper.AI.motivation ? paper.AI.motivation : '',
        method: paper.AI && paper.AI.method ? paper.AI.method : '',
        result: paper.AI && paper.AI.result ? paper.AI.result : '',
        conclusion: paper.AI && paper.AI.conclusion ? paper.AI.conclusion : ''
      });
    } catch (error) {
      console.error('Ëß£ÊûêJSONË°åÂ§±Ë¥•:', error, line);
    }
  });

  return result;
}

// Ëé∑ÂèñÊâÄÊúâÁ±ªÂà´Âπ∂ÊåâÂÅèÂ•ΩÊéíÂ∫è
function getAllCategories(data) {
  const categories = Object.keys(data);
  const catePaperCount = {};

  categories.forEach(category => {
    catePaperCount[category] = data[category] ? data[category].length : 0;
  });

  return {
    sortedCategories: categories.sort((a, b) => {
      return a.localeCompare(b);
    }),
    categoryCounts: catePaperCount
  };
}

function renderCategoryFilter(categories) {
  const container = document.querySelector('.category-scroll');
  const { sortedCategories, categoryCounts } = categories;

  let totalPapers = 0;
  Object.values(categoryCounts).forEach(count => {
    totalPapers += count;
  });

  container.innerHTML = `
    <button class="category-button ${currentCategory === 'all' ? 'active' : ''}" data-category="all">All<span class="category-count">${totalPapers}</span></button>
  `;

  sortedCategories.forEach(category => {
    const count = categoryCounts[category];
    const button = document.createElement('button');
    button.className = `category-button ${category === currentCategory ? 'active' : ''}`;
    button.innerHTML = `${category}<span class="category-count">${count}</span>`;
    button.dataset.category = category;
    button.addEventListener('click', () => {
      filterByCategory(category);
    });

    container.appendChild(button);
  });

  document.querySelector('.category-button[data-category="all"]').addEventListener('click', () => {
    filterByCategory('all');
  });
}

function filterByCategory(category) {
  currentCategory = category;

  document.querySelectorAll('.category-button').forEach(button => {
    button.classList.toggle('active', button.dataset.category === category);
  });

  // ‰øùÊåÅÂΩìÂâçÊøÄÊ¥ªÁöÑÂÖ≥ÈîÆËØç
  renderKeywordTags();

  // ‰øùÊåÅÂΩìÂâçÊøÄÊ¥ªÁöÑ‰ΩúËÄÖ
  renderAuthorTags();

  renderPapers();
}

// Â∏ÆÂä©ÂáΩÊï∞ÔºöÈ´ò‰∫ÆÊñáÊú¨‰∏≠ÁöÑÂåπÈÖçÂÜÖÂÆπ
function highlightMatches(text, terms, className = 'highlight-match') {
  if (!terms || terms.length === 0 || !text) {
    return text;
  }

  let result = text;

  // ÊåâÁÖßÈïøÂ∫¶ÊéíÂ∫èÂÖ≥ÈîÆËØçÔºå‰ªéÈïøÂà∞Áü≠ÔºåÈÅøÂÖçÁü≠ËØçÂÖàÊõøÊç¢ÂØºËá¥ÈïøËØçÂåπÈÖçÂ§±Ë¥•
  const sortedTerms = [...terms].sort((a, b) => b.length - a.length);

  // ‰∏∫ÊØè‰∏™ËØçÂàõÂª∫‰∏Ä‰∏™Ê≠£ÂàôË°®ËææÂºèÔºå‰ΩøÁî® 'gi' Ê†áÂøóËøõË°åÂÖ®Â±Ä„ÄÅ‰∏çÂå∫ÂàÜÂ§ßÂ∞èÂÜôÁöÑÂåπÈÖç
  sortedTerms.forEach(term => {
    const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    result = result.replace(regex, `<span class="${className}">$1</span>`);
  });

  return result;
}

function renderPapers() {
  const container = document.getElementById('paperContainer');
  container.innerHTML = '';
  container.className = `paper-container ${currentView === 'list' ? 'list-view' : ''}`;

  let papers = [];
  if (currentCategory === 'all') {
    const { sortedCategories } = getAllCategories(paperData);
    sortedCategories.forEach(category => {
      if (paperData[category]) {
        papers = papers.concat(paperData[category]);
      }
    });
  } else if (paperData[currentCategory]) {
    papers = paperData[currentCategory];
  }

  // ÂàõÂª∫ÂåπÈÖçËÆ∫ÊñáÁöÑÈõÜÂêà
  let filteredPapers = [...papers];

  // Â∫îÁî®ÊêúÁ¥¢ËøáÊª§
  if (searchQuery) {
    filteredPapers = filteredPapers.filter(paper => {
      const titleText = paper.title.toLowerCase();
      return titleText.includes(searchQuery);
    });
  }

  // ‰ΩúËÄÖÂåπÈÖçÔºå‰ΩÜ‰∏çËøáÊª§ÔºåÂè™ÊéíÂ∫è
  if (activeAuthors.length > 0) {
    // ÂØπËÆ∫ÊñáËøõË°åÊéíÂ∫èÔºåÂ∞ÜÂåπÈÖçÁöÑËÆ∫ÊñáÊîæÂú®ÂâçÈù¢
    filteredPapers.sort((a, b) => {
      const aMatchesAuthor = activeAuthors.some(author => {
        // ‰ªÖÂú®‰ΩúËÄÖ‰∏≠ÊêúÁ¥¢‰ΩúËÄÖÂêç
        return a.authors.toLowerCase().includes(author.toLowerCase());
      });

      const bMatchesAuthor = activeAuthors.some(author => {
        // ‰ªÖÂú®‰ΩúËÄÖ‰∏≠ÊêúÁ¥¢‰ΩúËÄÖÂêç
        return b.authors.toLowerCase().includes(author.toLowerCase());
      });

      if (aMatchesAuthor && !bMatchesAuthor) return -1;
      if (!aMatchesAuthor && bMatchesAuthor) return 1;
      return 0;
    });

    // Ê†áËÆ∞ÂåπÈÖçÁöÑËÆ∫Êñá
    filteredPapers.forEach(paper => {
      const matchesAuthor = activeAuthors.length > 0 ?
        activeAuthors.some(author => {
          return paper.authors.toLowerCase().includes(author.toLowerCase());
        }) : false;

      // Ê∑ªÂä†ÂåπÈÖçÊ†áËÆ∞ÔºàÁî®‰∫éÂêéÁª≠È´ò‰∫ÆÊï¥‰∏™ËÆ∫ÊñáÂç°ÁâáÔºâ
      paper.isMatched = matchesAuthor;

      // Ê∑ªÂä†ÂåπÈÖçÂéüÂõ†ÔºàÁî®‰∫éÊòæÁ§∫ÂåπÈÖçÊèêÁ§∫Ôºâ
      if (paper.isMatched) {
        paper.matchReason = [];
        const matchedAuthors = activeAuthors.filter(author =>
          paper.authors.toLowerCase().includes(author.toLowerCase())
        );
        if (matchedAuthors.length > 0) {
          paper.matchReason.push(`‰ΩúËÄÖ: ${matchedAuthors.join(', ')}`);
        }
      }
    });
  }

  // Â≠òÂÇ®ÂΩìÂâçËøáÊª§ÂêéÁöÑËÆ∫ÊñáÂàóË°®ÔºåÁî®‰∫éÁÆ≠Â§¥ÈîÆÂØºËà™
  currentFilteredPapers = [...filteredPapers];

  if (filteredPapers.length === 0) {
    container.innerHTML = `
      <div class="loading-container">
        <p>No paper found.</p>
      </div>
    `;
    return;
  }

  filteredPapers.forEach((paper, index) => {
    const paperCard = document.createElement('div');
    // Ê∑ªÂä†ÂåπÈÖçÈ´ò‰∫ÆÁ±ª
    paperCard.className = `paper-card ${paper.isMatched ? 'matched-paper' : ''}`;
    paperCard.dataset.id = paper.id || paper.url;

    if (paper.isMatched) {
      // Ê∑ªÂä†ÂåπÈÖçÂéüÂõ†ÊèêÁ§∫
      paperCard.title = `ÂåπÈÖç: ${paper.matchReason.join(' | ')}`;
    }

    const categoryTags = paper.allCategories ?
      paper.allCategories.map(cat => `<span class="category-tag">${cat}</span>`).join('') :
      `<span class="category-tag">${paper.category}</span>`;

    // Ê†áÈ¢òÂíåÊëòË¶ÅÔºà‰∏çÂÜçÈ´ò‰∫ÆÂÖ≥ÈîÆËØçÔºâ
    const highlightedTitle = paper.title;
    const highlightedSummary = paper.summary;

    // È´ò‰∫Æ‰ΩúËÄÖ‰∏≠ÁöÑÂåπÈÖç
    const highlightedAuthors = activeAuthors.length > 0
      ? highlightMatches(paper.authors, activeAuthors, 'author-highlight')
      : paper.authors;

    paperCard.innerHTML = `
      <div class="paper-card-index">${index + 1}</div>
      ${paper.isMatched ? '<div class="match-badge" title="ÂåπÈÖçÊÇ®ÁöÑÊêúÁ¥¢Êù°‰ª∂"></div>' : ''}
      <div class="paper-card-header">
        <h3 class="paper-card-title">${highlightedTitle}</h3>
        <p class="paper-card-authors">${highlightedAuthors}</p>
        <div class="paper-card-categories">
          ${categoryTags}
        </div>
      </div>
      <div class="paper-card-body">
        <p class="paper-card-summary">${highlightedSummary}</p>
        <div class="paper-card-footer">
          <span class="paper-card-date">${formatDate(paper.date)}</span>
          <span class="paper-card-link">Details</span>
        </div>
      </div>
    `;

    paperCard.addEventListener('click', () => {
      currentPaperIndex = index; // ËÆ∞ÂΩïÂΩìÂâçÁÇπÂáªÁöÑËÆ∫ÊñáÁ¥¢Âºï
      showPaperDetails(paper, index + 1);
    });

    container.appendChild(paperCard);
  });
}

function showPaperDetails(paper, paperIndex) {
  const modal = document.getElementById('paperModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const paperLink = document.getElementById('paperLink');
  const pdfLink = document.getElementById('pdfLink');
  const htmlLink = document.getElementById('htmlLink');

  // Â≠òÂÇ®ÂΩìÂâçËÆ∫ÊñáÊï∞ÊçÆ
  currentPaperData = paper;

  // ÈáçÁΩÆÊ®°ÊÄÅÊ°ÜÁöÑÊªöÂä®‰ΩçÁΩÆ
  modalBody.scrollTop = 0;

  // È´ò‰∫ÆÊ†áÈ¢ò‰∏≠ÁöÑÂÖ≥ÈîÆËØç
  const highlightedTitle = paper.title;

  // Âú®Ê†áÈ¢òÂâçÊ∑ªÂä†Á¥¢ÂºïÂè∑
  modalTitle.innerHTML = paperIndex ? `<span class="paper-index-badge">${paperIndex}</span> ${highlightedTitle}` : highlightedTitle;

  const abstractText = paper.details || '';

  const categoryDisplay = paper.allCategories ?
    paper.allCategories.join(', ') :
    paper.category;

  // È´ò‰∫Æ‰ΩúËÄÖ‰∏≠ÁöÑÂåπÈÖç
  const highlightedAuthors = activeAuthors.length > 0
    ? highlightMatches(paper.authors, activeAuthors, 'author-highlight')
    : paper.authors;

  // ÁßªÈô§ÂÖ≥ÈîÆËØçÈ´ò‰∫ÆÔºå‰ΩøÁî®ÂéüÂßãÂÜÖÂÆπ
  const highlightedSummary = paper.summary;
  const highlightedAbstract = abstractText;
  const highlightedMotivation = paper.motivation;
  const highlightedMethod = paper.method;
  const highlightedResult = paper.result;
  const highlightedConclusion = paper.conclusion;

  // Âà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÊòæÁ§∫È´ò‰∫ÆËØ¥Êòé
  const showHighlightLegend = activeAuthors.length > 0;

  // Ê∑ªÂä†ÂåπÈÖçÊ†áËÆ∞
  const matchedPaperClass = paper.isMatched ? 'matched-paper-details' : '';

  const modalContent = `
    <div class="paper-details ${matchedPaperClass}">
      <p><strong>Authors: </strong>${highlightedAuthors}</p>
      <p><strong>Categories: </strong>${categoryDisplay}</p>
      <p><strong>Date: </strong>${formatDate(paper.date)}</p>



      <h3>TL;DR</h3>
      <div class="summary-tabs">
        ${paper.translatedSummary ? `
        <div class="tab-buttons">
          <button class="tab-button active" data-tab="translated">Translated</button>
          <button class="tab-button" data-tab="original">Original</button>
        </div>
        <div class="tab-content">
          <div class="tab-pane active" id="translated-summary">
            ${paper.translatedSummary}
          </div>
          <div class="tab-pane" id="original-summary">
            ${highlightedSummary}
          </div>
        </div>
        ` : `
        <div class="paper-summary-content">${highlightedSummary}</div>
        `}
      </div>

      <div class="paper-sections">
        ${paper.motivation ? `<div class="paper-section" data-section="motivation"><h4>Motivation</h4><p>${highlightedMotivation}</p></div>` : ''}
        ${paper.method ? `<div class="paper-section" data-section="method"><h4>Method</h4><p>${highlightedMethod}</p></div>` : ''}
        ${paper.result ? `<div class="paper-section" data-section="result"><h4>Result</h4><p>${highlightedResult}</p></div>` : ''}
        ${paper.conclusion ? `<div class="paper-section" data-section="conclusion"><h4>Conclusion</h4><p>${highlightedConclusion}</p></div>` : ''}
      </div>

      ${highlightedAbstract ? `<h3>Abstract</h3><div class="original-abstract">${highlightedAbstract}</div>` : ''}




    </div>
  `;

  // Update modal content
  document.getElementById('modalBody').innerHTML = modalContent;
  document.getElementById('paperLink').href = paper.url;
  document.getElementById('pdfLink').href = paper.url.replace('abs', 'pdf');
  document.getElementById('htmlLink').href = paper.url.replace('abs', 'html');

    // Add event listeners to the action buttons
  const bookmarkButton = document.getElementById('bookmarkButton');
  const downloadPdfButton = document.getElementById('downloadPdfButton');
  const showPdfButton = document.getElementById('showPdfButton');

    if (bookmarkButton) {
    // Update bookmark button appearance based on current state
    const isBookmarkedPaper = isBookmarked(paper);
    bookmarkButton.title = isBookmarkedPaper ? 'Remove from bookmarks' : 'Add to bookmarks';
    const bookmarkIcon = bookmarkButton.querySelector('path');
    if (bookmarkIcon) {
      bookmarkIcon.setAttribute('fill', isBookmarkedPaper ? '#ffd700' : 'none');
    }

    bookmarkButton.paperData = paper;
    bookmarkButton.addEventListener('click', () => {
      toggleBookmark(paper);
      // Update button appearance after toggle
      const newIsBookmarked = isBookmarked(paper);
      bookmarkButton.title = newIsBookmarked ? 'Remove from bookmarks' : 'Add to bookmarks';
      const icon = bookmarkButton.querySelector('path');
      if (icon) {
        icon.setAttribute('fill', newIsBookmarked ? '#ffd700' : 'none');
      }
    });
  }

  if (downloadPdfButton) {
    downloadPdfButton.addEventListener('click', () => downloadPaper(paper));
  }

  if (showPdfButton) {
    showPdfButton.addEventListener('click', () => showPdfInModal(paper));
  }

  // Add tab functionality
  const tabButtons = document.querySelectorAll('.tab-button');
  tabButtons.forEach(button => {
    button.addEventListener('click', (e) => {
      const tab = e.target.getAttribute('data-tab');

      // Remove active class from all tabs and buttons
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

      // Add active class to clicked button and corresponding tab
      e.target.classList.add('active');
      document.getElementById(`${tab}-summary`).classList.add('active');
    });
  });

  // Removed Kimi chat integration

  // Êõ¥Êñ∞ËÆ∫Êñá‰ΩçÁΩÆ‰ø°ÊÅØ
  const paperPosition = document.getElementById('paperPosition');
  if (paperPosition && currentFilteredPapers.length > 0) {
    paperPosition.textContent = `${currentPaperIndex + 1} / ${currentFilteredPapers.length}`;
  }

  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  const modal = document.getElementById('paperModal');
  const modalBody = document.getElementById('modalBody');

  // ÈáçÁΩÆÊ®°ÊÄÅÊ°ÜÁöÑÊªöÂä®‰ΩçÁΩÆ
  modalBody.scrollTop = 0;

  modal.classList.remove('active');
  document.body.style.overflow = '';
}

// Show PDF in modal
function showPdfInModal(paper) {
  const pdfUrl = paper.url.replace('abs', 'pdf');
  window.open(pdfUrl, '_blank');
}

// ÂØºËà™Âà∞‰∏ä‰∏ÄÁØáËÆ∫Êñá
function navigateToPreviousPaper() {
  if (currentFilteredPapers.length === 0) return;

  currentPaperIndex = currentPaperIndex > 0 ? currentPaperIndex - 1 : currentFilteredPapers.length - 1;
  const paper = currentFilteredPapers[currentPaperIndex];
  showPaperDetails(paper, currentPaperIndex + 1);
}

// ÂØºËà™Âà∞‰∏ã‰∏ÄÁØáËÆ∫Êñá
function navigateToNextPaper() {
  if (currentFilteredPapers.length === 0) return;

  currentPaperIndex = currentPaperIndex < currentFilteredPapers.length - 1 ? currentPaperIndex + 1 : 0;
  const paper = currentFilteredPapers[currentPaperIndex];
  showPaperDetails(paper, currentPaperIndex + 1);
}

// ÊòæÁ§∫ÈöèÊú∫ËÆ∫Êñá
function showRandomPaper() {
  // Ê£ÄÊü•ÊòØÂê¶ÊúâÂèØÁî®ÁöÑËÆ∫Êñá
  if (currentFilteredPapers.length === 0) {
    console.log('No papers available to show random paper');
    return;
  }

  // ÁîüÊàêÈöèÊú∫Á¥¢Âºï
  const randomIndex = Math.floor(Math.random() * currentFilteredPapers.length);
  const randomPaper = currentFilteredPapers[randomIndex];

  // Êõ¥Êñ∞ÂΩìÂâçËÆ∫ÊñáÁ¥¢Âºï
  currentPaperIndex = randomIndex;

  // ÊòæÁ§∫ÈöèÊú∫ËÆ∫Êñá
  showPaperDetails(randomPaper, currentPaperIndex + 1);

  // ÊòæÁ§∫ÈöèÊú∫ËÆ∫ÊñáÊåáÁ§∫Âô®
  showRandomPaperIndicator();

  console.log(`Showing random paper: ${randomIndex + 1}/${currentFilteredPapers.length}`);
}

// ÊòæÁ§∫ÈöèÊú∫ËÆ∫ÊñáÊåáÁ§∫Âô®
function showRandomPaperIndicator() {
  // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÊåáÁ§∫Âô®
  const existingIndicator = document.querySelector('.random-paper-indicator');
  if (existingIndicator) {
    existingIndicator.remove();
  }

  // ÂàõÂª∫Êñ∞ÁöÑÊåáÁ§∫Âô®
  const indicator = document.createElement('div');
  indicator.className = 'random-paper-indicator';
  indicator.textContent = 'Random Paper';

  // Ê∑ªÂä†Âà∞È°µÈù¢
  document.body.appendChild(indicator);

  // 3ÁßíÂêéËá™Âä®ÁßªÈô§
  setTimeout(() => {
    if (indicator && indicator.parentNode) {
      indicator.remove();
    }
  }, 3000);
}

function toggleDatePicker() {
  const datePicker = document.getElementById('datePickerModal');
  datePicker.classList.toggle('active');

  if (datePicker.classList.contains('active')) {
    document.body.style.overflow = 'hidden';

    // ÈáçÊñ∞ÂàùÂßãÂåñÊó•ÊúüÈÄâÊã©Âô®‰ª•Á°Æ‰øùÂÆÉÂèçÊò†ÊúÄÊñ∞ÁöÑÂèØÁî®Êó•Êúü
    if (flatpickrInstance) {
      flatpickrInstance.setDate(currentDate, false);
    }
  } else {
    document.body.style.overflow = '';
  }
}

function toggleView() {
  currentView = currentView === 'grid' ? 'list' : 'grid';
  document.getElementById('paperContainer').classList.toggle('list-view', currentView === 'list');
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'numeric',
    day: 'numeric'
  });
}

async function loadPapersByDateRange(startDate, endDate) {
  // Ëé∑ÂèñÊó•ÊúüËåÉÂõ¥ÂÜÖÁöÑÊâÄÊúâÊúâÊïàÊó•Êúü
  const validDatesInRange = availableDates.filter(date => {
    return date >= startDate && date <= endDate;
  });

  if (validDatesInRange.length === 0) {
    alert('No available papers in the selected date range.');
    return;
  }

  currentDate = `${startDate} to ${endDate}`;
  document.getElementById('currentDate').textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;

  // ‰∏çÂÜçÈáçÁΩÆÊøÄÊ¥ªÁöÑÂÖ≥ÈîÆËØçÂíå‰ΩúËÄÖ
  // ËÄåÊòØ‰øùÊåÅÂΩìÂâçÈÄâÊã©Áä∂ÊÄÅ

  const container = document.getElementById('paperContainer');
  container.innerHTML = `
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading papers from ${formatDate(startDate)} to ${formatDate(endDate)}...</p>
    </div>
  `;

  try {
    // Âä†ËΩΩÊâÄÊúâÊó•ÊúüÁöÑËÆ∫ÊñáÊï∞ÊçÆ
    const allPaperData = {};

    for (const date of validDatesInRange) {
      const language = availableDateFiles[date];
      if (!language) {
        console.warn(`No AI enhanced file found for date: ${date}, skipping...`);
        continue;
      }
      const response = await fetch(`data/${date}_AI_enhanced_${language}.jsonl`);
      const text = await response.text();
      const dataPapers = parseJsonlData(text, date);

      // ÂêàÂπ∂Êï∞ÊçÆ
      Object.keys(dataPapers).forEach(category => {
        if (!allPaperData[category]) {
          allPaperData[category] = [];
        }
        allPaperData[category] = allPaperData[category].concat(dataPapers[category]);
      });
    }

    paperData = allPaperData;

    const categories = getAllCategories(paperData);

    renderCategoryFilter(categories);

    renderPapers();
  } catch (error) {
    console.error('Âä†ËΩΩËÆ∫ÊñáÊï∞ÊçÆÂ§±Ë¥•:', error);
    container.innerHTML = `
      <div class="loading-container">
        <p>Loading data fails. Please retry.</p>
        <p>Error messages: ${error.message}</p>
      </div>
    `;
  }
}

// Ê∏ÖÈô§ÊâÄÊúâÊøÄÊ¥ªÁöÑÂÖ≥ÈîÆËØç
function clearAllKeywords() {
  activeKeywords = [];
  renderKeywordTags();
  // ÈáçÊñ∞Ê∏≤ÊüìËÆ∫ÊñáÂàóË°®ÔºåÁßªÈô§ÂÖ≥ÈîÆËØçÂåπÈÖçÁöÑÈ´ò‰∫ÆÂíå‰ºòÂÖàÊéíÂ∫è
  renderPapers();
}

// Ê∏ÖÈô§ÊâÄÊúâ‰ΩúËÄÖËøáÊª§
function clearAllAuthors() {
  activeAuthors = [];
  renderAuthorTags();
  // ÈáçÊñ∞Ê∏≤ÊüìËÆ∫ÊñáÂàóË°®ÔºåÁßªÈô§‰ΩúËÄÖÂåπÈÖçÁöÑÈ´ò‰∫ÆÂíå‰ºòÂÖàÊéíÂ∫è
  renderPapers();
}

// ÂàáÊç¢PDFÈ¢ÑËßàÂô®Â§ßÂ∞è
function togglePdfSize(button) {
  const pdfContainer = button.closest('.pdf-preview-section').querySelector('.pdf-container');
  const iframe = pdfContainer.querySelector('iframe');
  const expandIcon = button.querySelector('.expand-icon');
  const collapseIcon = button.querySelector('.collapse-icon');

  if (pdfContainer.classList.contains('expanded')) {
    // ÊÅ¢Â§çÊ≠£Â∏∏Â§ßÂ∞è
    pdfContainer.classList.remove('expanded');
    iframe.style.height = '800px';
    expandIcon.style.display = 'block';
    collapseIcon.style.display = 'none';

    // ÁßªÈô§ÈÅÆÁΩ©Â±Ç
    const overlay = document.querySelector('.pdf-overlay');
    if (overlay) {
      overlay.remove();
    }
  } else {
    // ÊîæÂ§ßÊòæÁ§∫
    pdfContainer.classList.add('expanded');
    iframe.style.height = '90vh';
    expandIcon.style.display = 'none';
    collapseIcon.style.display = 'block';

    // Ê∑ªÂä†ÈÅÆÁΩ©Â±Ç
    const overlay = document.createElement('div');
    overlay.className = 'pdf-overlay';
    document.body.appendChild(overlay);

    // ÁÇπÂáªÈÅÆÁΩ©Â±ÇÊó∂Êî∂Ëµ∑PDF
    overlay.addEventListener('click', () => {
      togglePdfSize(button);
    });
  }
}